#!/usr/bin/env bash

# Get absolute path to the root of the project repo
PROJECT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null)"

# Fall back to parent directory if not in a Git repo (for CI/local testing edge cases)
if [ -z "$PROJECT_ROOT" ]; then
  PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
fi

# Create a temp local repo
create_temp_git_repo() {
  TMP_DIR=$(mktemp -d)
  cd "$TMP_DIR" || exit 1
  git init -b main > /dev/null
  echo "$TMP_DIR"
}

# Install hook on temp repo
install_hook() {
  local HOOK_NAME="$1"
  cp "$PROJECT_ROOT/hooks/$HOOK_NAME" ".git/hooks/$HOOK_NAME"
  chmod +x ".git/hooks/$HOOK_NAME"
}

# Copy scenario data into target dir (default: terraform/)
copy_test_data() {
  local scenario="$1"
  local test_script_path="$2"
  local target_dir="${3:-terraform}"

  # Get absolute path to test-data dir next to the test script
  local test_dir
  test_dir="$(cd "$(dirname "$test_script_path")" && pwd)"

  rm -rf "$target_dir"
  mkdir -p "$target_dir"
  cp -r "$test_dir/test-data/$scenario/"* "$target_dir"/
}

# Reset git index and working dir (optional dir arg to just unstage)
reset_git() {
  git reset --hard >/dev/null 2>&1
  git clean -fd >/dev/null 2>&1
}