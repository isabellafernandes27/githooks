#!/bin/sh

# Ticket DDDS-18: Terraform fmt

# Check if /terraform directory exists
if [ ! -d "terraform" ]; then
  echo "Directory 'terraform' not found. Aborting push."
  exit 1
fi

# Read refs from stdin
while read local_ref local_sha remote_ref remote_sha
do
  # Determine diff range
  if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
    # New branch or new ref, diff against empty tree
    diff_range="$local_sha"
  else
    diff_range="$remote_sha..$local_sha"
  fi

  # Get list of changed .tf files under terraform/
  changed_files=$(git diff --name-only "$diff_range" -- 'terraform/*.tf')

  if [ -z "$changed_files" ]; then
    # No terraform files changed, continue to next ref or allow push
    continue
  fi

  # Check formatting on each changed file
  for file in $changed_files; do
    if ! terraform fmt -check "$file"; then
      echo "Terraform file '$file' is not properly formatted. Please run 'terraform fmt $file'."
      exit 1
    fi
  done
done

# Ticket DDDS-19: Terraform validate

# All checks passed or no terraform files changed
exit 0