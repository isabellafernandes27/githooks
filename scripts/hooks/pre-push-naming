#!/bin/bash

# Ticket DDDS-20: Deny push if branch does not meet validation criteria

# Colors for messages
RED='\033[0;31m'
GREEN='\033[0;32m'
ORANGE='\033[0;33m'
NOCOLOR='\033[0m'

# Branches where pushes are disallowed
if [ -z "$BRANCHES_TO_SKIP" ]; then
  BRANCHES_TO_SKIP=(master production staging)
fi

# Regex to validate branch names
VALID_BRANCH_REGEX="(^(feature|hotfix|bugfix|library|prerelease|release|dev|improvement)\/[A-Z]+\-[0-9]+(-.*)?$)|^([A-Z]+\-[0-9]+(-.*)?$)|^(main)$"

# Get current branch name
BRANCH_NAME="$(git rev-parse --abbrev-ref HEAD)"

# Check if pushing to a protected branch (skip validation)
for branch in "${BRANCHES_TO_SKIP[@]}"; do
  if [[ "$BRANCH_NAME" == "$branch" ]]; then
    echo -e "${RED}Pushes directly to branch '${branch}' are not allowed.${NOCOLOR}"
    exit 1
  fi
done

# Validate branch name against regex
if [[ "$BRANCH_NAME" =~ $VALID_BRANCH_REGEX ]]; then
  echo -e "${GREEN}Current branch name is valid: ${BRANCH_NAME}${NOCOLOR}"
  # You can put additional actions here (e.g., tests, linting)
  exit 0
else
  echo -e "\n${RED}Pre-commit: Please correct the branch name${NOCOLOR}"
  printf "\nBranch name not as per the defined rules (e.g.:  "
  echo -e "${GREEN}feature, hotfix, bugfix, library, prerelease, release, dev, improvement, hotfix-102, XXXX-1234, XXXX-1234-something${NOCOLOR})\n"
  echo -e "${ORANGE}You cannot push in these branches directly: ${BRANCHES_TO_SKIP[@]}"
  echo -e "\nCurrent branch name: ${BRANCH_NAME}"
  echo -e "\nTo rename your branch, run:"
  echo -e "  git branch -m feature/IDDS-1234-short-description"
  exit 1
fi
