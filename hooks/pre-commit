#!/usr/bin/env bash
set -euo pipefail

RED=$'\033[0;31m'
GREEN=$'\033[0;32m'
ORANGE=$'\033[0;33m'
NOCOLOR=$'\033[0m'

# Only run if there are staged .tf files
staged_tf_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.tf$' || true)
if [ -z "$staged_tf_files" ]; then
  echo "${GREEN}No staged Terraform files to format. Skipping."
  exit 0
fi

# Run terraform fmt on each staged .tf file and exit immediately if it fails
for file in $staged_tf_files; do
  echo "${ORANGE}Running terraform fmt on: $file${NOCOLOR}"
  if ! terraform fmt "$file"; then
    echo "${RED}terraform fmt failed on file: $file${NOCOLOR}"
    exit 1
  fi
done

# Re-stage files after formatting
git add $staged_tf_files

echo "${GREEN}Terraform formatting passed and changes staged.${NOCOLOR}"

exit 0