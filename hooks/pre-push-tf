#!/usr/bin/env bash

# Colors for messages
RED=$'\033[0;31m'
GREEN=$'\033[0;32m'
NOCOLOR=$'\033[0m'
BOLD=$'\033[1m'

# Require Bash 4.0+ for associative arrays
if ((BASH_VERSINFO[0] < 4)); then
  echo "${RED}${BOLD}This hook requires Bash 4.0 or newer. Found: $BASH_VERSION. ${NOCOLOR}Continuing without hook."
  exit 0
fi

declare -A dir_files_map

# Check if there are any terraform files staged in the diff range
# Read refs from stdin to determine diff_range
while read -r local_ref local_sha remote_ref remote_sha; do
  if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
    if git rev-parse "${local_sha}^" >/dev/null 2>&1; then
      diff_range="${local_sha}^..${local_sha}"
    else
      diff_range=$(git hash-object -t tree /dev/null)..${local_sha}
    fi
  else
    diff_range="$remote_sha..$local_sha"
  fi
done

# Get list of changed .tf files in the diff range
changed_tf_files=$(git diff --name-only "$diff_range" -- '*.tf' || true)

if [ -z "$changed_tf_files" ]; then
  echo "${GREEN}No terraform (.tf) files changed. Skipping terraform validation.${NOCOLOR}"
  exit 0
fi

# Group changed files by directory
while IFS= read -r file; do
  dir=$(dirname "$file")
  # only add directory if it contains .tf files
  if ls "$dir"/*.tf >/dev/null 2>&1; then
    if [[ -z "${dir_files_map[$dir]:-}" ]]; then
      dir_files_map[$dir]="$file"
    else
      dir_files_map[$dir]+=" $file"
    fi
  fi
done <<< "$changed_tf_files"


# Iterate through each directory with changes
for dir in "${!dir_files_map[@]}"; do

  # cd into the directory for init & validate
  if ! cd "$dir"; then
    echo "${RED}Failed to enter directory: $dir. Skipping validation.${NOCOLOR}"
    exit 1
  fi

  # Initialize terraform (no backend)
  terraform init -backend=false -input=false >/dev/null 2>&1 || {
    echo "${RED}terraform init failed in $dir${NOCOLOR}"
    exit 1
    cd - >/dev/null
  }

  # Run terraform validate
  if terraform validate >/dev/null 2>&1; then
    echo "${GREEN}Terraform validation succeeded in $dir${NOCOLOR}"
  else
    echo "${RED}Terraform validation failed in $dir${NOCOLOR}"
    exit 1
  fi

  cd - >/dev/null || exit 1
done

# Summary
echo
echo "Terraform validation ${BOLD}succeeded."

exit 0