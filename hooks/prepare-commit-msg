#!/usr/bin/env bash

# Ticket DDDS-17: Pre-pends ticket number/branch name in git message

COMMIT_MSG_FILE="$1"
COMMIT_SOURCE="${TEST_COMMIT_SOURCE:-$2}"   # Use env var in tests, fallback to real arg
SHA="$3"

# Only act on commit types where a message is expected (not merges or squashes)
if [[ "$COMMIT_SOURCE" == "squash" ]]; then
  exit 0
fi

# Get current branch name safely
BRANCH_NAME=$(git symbolic-ref --quiet --short HEAD 2>/dev/null || echo "")

# Extract Jira ticket number from branch name (DDDS-123 from DDDS-123-add-login)
if [[ "$BRANCH_NAME" =~ ([A-Z]+-[0-9]+) ]]; then
  TICKET_ID="${BASH_REMATCH[1]}"
else
  # No valid ticket found â€” do nothing
  exit 0
fi

# Read the existing message
ORIGINAL_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip if the message already starts with the ticket
if [[ "$ORIGINAL_MSG" =~ ^$TICKET_ID: ]]; then
  exit 0
fi

# Update commit message to prepend ticket ID
echo "$TICKET_ID: $ORIGINAL_MSG" > "$COMMIT_MSG_FILE"
